#include:
#  - local: ".gitlab/jobs/codeql-analysis.yml"
#  - local: ".gitlab/jobs/semgrep-analysis.yml"
#  - local: ".gitlab/jobs/mypy.yml"
#  - local: ".gitlab/jobs/cypress.yml"
#  - local: ".gitlab/jobs/frontend.yml"

stages:
  - test

variables:
  PROJECT: "mistral"

backend_tests:
  stage: test
  tags:
    - mistral
    - openstack-driver
  variables:
    SUBMODULE_DIR: $CI_PROJECT_DIR/submodules
  script:
    - export PATH="$HOME/.local/bin:$PATH"
    - |
      echo "Check for compatible RaPyDo version..."
      rapydo version | tee version_output.txt

      # get versions from the file version_output
      required_version=$(grep "required rapydo" version_output.txt | sed -E 's/.*required rapydo: ([0-9\.]+).*/\1/')
      current_version=$(grep "^rapydo:" version_output.txt | sed -E 's/rapydo: ([0-9\.]+).*/\1/')

      echo "Required version: $required_version"
      echo "Current version: $current_version"

      if [ "$required_version" != "$current_version" ]; then
        echo "RaPyDo version NOT compatible. Downgrading..."
        pip3 install --upgrade git+https://github.com/rapydo/do.git@$required_version
      else
        echo "Correct version of RaPyDo already installed."
      fi
    # Init Rapydo
    - echo "INIT Rapydo rapydo --testing --project $PROJECT init --force"
    - rapydo --testing --project $PROJECT init --force
    - rapydo version
    - rapydo pull --quiet
    - rapydo build

    # Prepare testing environment
    - .gitlab/scripts/setup-backend-and-datasets.sh "${PROJECT}" "${DATASET_URL}"

    # Test arpaesimc tools
    - rapydo shell backend "bash /code/tests/custom/test_arpaesimc.sh"

    # Run tests
    - rapydo shell backend 'restapi tests --wait --destroy --folder custom'
    - LOGURU_LEVEL=WARNING rapydo list services
    - |
      if LOGURU_LEVEL=WARNING rapydo list services | grep -E "Exit|Restarting|Created"; then
      exit 1
      fi
    - tail -100 data/logs/backend-server.log || true
    - tail -100 data/logs/security-events.log || true
    - rapydo logs || true
