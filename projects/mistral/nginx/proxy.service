error_page 503 /maintenance.html;
location = /maintenance.html {
  alias /usr/share/nginx/html/maintenance.html;
  include /etc/nginx/sites-enabled/security-headers;
}


# Optional: Add Retry-After header
# add_header Retry-After 3600;



location ~ /nwp/?$ {
  return 301 /nwp/ICON-2I_SURFACE_PRESSURE_LEVELS;
}

location /nwp/ICON-2I_SURFACE_PRESSURE_LEVELS {
   alias /grib_extraction/;
   autoindex on;
}

location = /catalog.rdf {
    alias /catalog/catalog.rdf;
    default_type application/rdf+xml;
}

location /cms/ {
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_proxied any;
  gzip_vary on;
  if (-f /etc/nginx/maintenance.flag.ui) {
    return 503;
  }
  set $strapi "http://strapi:1337";
  rewrite ^/cms/(.+) /$1 break;
  proxy_pass $strapi;
  proxy_http_version 1.1;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Host $http_host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "Upgrade";
  proxy_pass_request_headers on;
  return 200 "OK";
}

location /ui/ {
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_proxied any;
  gzip_vary on;
  if (-f /etc/nginx/maintenance.flag.ui) {
    return 503;
  }
  set $ui "http://ui:4200";
  proxy_pass $ui;
  proxy_http_version 1.1;
  # proxy_set_header X-Forwarded-Host $host;
  # proxy_set_header X-Forwarded-Server $host;
  # proxy_set_header X-Real-IP $remote_addr;
  # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  # proxy_set_header X-Forwarded-Proto $scheme;
  # proxy_set_header Host $http_host;
  # proxy_set_header Upgrade $http_upgrade;
  # proxy_set_header Connection "Upgrade";
  # proxy_pass_request_headers on;
}

location /newsletter/ {
    proxy_pass https://list.cineca.it/cgi-bin/mailman/;
    proxy_set_header Host list.cineca.it;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Main Matomo application
location /analytics/ {
  # Enable gzip compression for better performance
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
  gzip_proxied any;
  gzip_vary on;
  
  # Use correct port for Matomo container (internal port 80)
  proxy_pass http://matomo/;
  
  # Essential headers for proper functioning
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  
  # Headers for assets and AJAX requests
  proxy_set_header X-Forwarded-Server $host;
  proxy_http_version 1.1;
  proxy_set_header Connection "";
  
  # Important: Preserve the original request URI for assets
  proxy_set_header X-Original-URI $request_uri;
  
  # Timeout settings for better reliability
  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;
  
  # Handle redirects properly
  proxy_redirect default;
  proxy_redirect http://matomo/ /analytics/;
  proxy_redirect https://matomo/ /analytics/;
}

# Handle Matomo assets and static files that might be requested without /analytics/ prefix
location ~ ^/(plugins|themes|libs|misc|js|node_modules|vendor)/ {
  # Redirect to the correct path under /analytics/
  return 301 /analytics$request_uri;
}

# Handle specific Matomo files that might be requested at root
location ~ ^/(index\.php|matomo\.php|matomo\.js|piwik\.js|piwik\.php)$ {
  # Redirect to the correct path under /analytics/
  return 301 /analytics$request_uri;
}