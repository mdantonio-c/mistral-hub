# Main Matomo application
location /analytics/ {
  # Enable gzip compression for better performance
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
  gzip_proxied any;
  gzip_vary on;

  # Direct proxy pass to matomo
  proxy_pass http://matomo/;
  
  # Gracefully handle when Matomo is unreachable
  proxy_intercept_errors on;
  error_page 502 503 504 =204 /analytics_unavailable;

  # Essential headers for proper functioning
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;

  # Headers for assets and AJAX requests
  proxy_set_header X-Forwarded-Server $host;
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  # Important: Preserve the original request URI for assets
  proxy_set_header X-Original-URI $request_uri;

  # Timeout settings for better reliability
  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;

  # Handle redirects properly
  proxy_redirect default;
}

# Internal location for when analytics is unavailable
location = /analytics_unavailable {
  internal;
  return 204;  # No Content - service unavailable
}

# Handle Matomo assets and static files that might be requested without /analytics/ prefix
location ~ ^/(plugins|themes|libs|misc|js|node_modules|vendor)/ {
  # Redirect to the correct path under /analytics/
  return 301 /analytics$request_uri;
}

# Handle specific Matomo files that might be requested at root
location ~ ^/(index\.php|matomo\.php|matomo\.js|piwik\.js|piwik\.php)$ {
  # Redirect to the correct path under /analytics/
  return 301 /analytics$request_uri;
}