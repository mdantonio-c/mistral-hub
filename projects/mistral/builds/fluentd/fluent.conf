<source>
  @type forward
  port 24224
  bind 0.0.0.0
  
  # Handle high volume connections
  backlog 2048                             # increase connection backlog
  chunk_size_limit 50m                     # limit individual message size
</source>

<match nginx>
  @type file
  path /var/log/fluentd/nginx.${tag}.%Y-%m-%d-%H-%M.log   # base filename, time format handled in buffer
  # No compression - logs saved uncompressed

  # keep logs unchanged: extract the raw log field from the JSON
  <format>
    @type single_value
    message_key log                   # write only the "log" field contents
  </format>

  <buffer tag,time>
    @type file
    path /var/log/fluentd/buffer/nginx   # buffer directory

    timekey 1m                              # rotate every 1 minute
    timekey_use_utc true
    timekey_wait 10s                        # wait to make sure all events are flushed
    
    # Reduce chunk size to handle high volume
    chunk_limit_size 100m                   # reduced from 500m to 100m per chunk
    chunk_limit_records 100000              # reduced from 1M to 100k records per chunk

    # Increase total buffer storage significantly
    total_limit_size 5g                     # increased from 1GB to 5GB max storage
    queued_chunks_limit_size 100            # allow more chunks in queue
    
    # More aggressive flushing to prevent overflow
    flush_interval 5s                       # flush every 5 seconds (was 10s)
    flush_thread_count 4                    # use multiple threads for flushing
    
    # Handle overflow better
    overflow_action drop_oldest_chunk       # drop oldest chunks instead of throwing errors
    retry_max_times 3                       # retry failed writes
    retry_wait 1s                           # wait between retries
  </buffer>
</match>

<match **>
  @type stdout
</match>
